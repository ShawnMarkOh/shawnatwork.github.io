<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Airport Time Zone Search</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone-with-data.min.js"></script>
  <style>
    body{background-color:#f0f0f0;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;margin:0}h1,p{font-size:24px}#search-container{text-align:center}#search-input{width:300px;padding:8px;border:1px solid #ccc;border-radius:4px}#search-results{margin-top:20px;text-align:left}.modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5)}.modal-content{background-color:#fff;border:2px solid #000;margin:15% auto;padding:20px;width:80%}.modal-close{float:right;cursor:pointer}.changelog-link{cursor:pointer;color:blue;text-decoration:underline}.weather-container{margin-top:10px}.weather-info{font-size:16px;margin-top:5px}
  </style>
</head>
<body>
  <!-- Work in Progress Modal (Displayed on Page Load) -->
  <div class="modal">
    <div class="modal-content">
      <span class="modal-close" style="float:right;cursor:pointer;">&times;</span>
      <p><b>This tool is a work in progress and does not include all airport IATA codes. If you have suggestions, please Teams me! - Shawn</b></p>
    </div>
  </div>

  <!-- Search Container -->
  <div id="search-container">
    <h1>Airport Time Zone Search</h1>
    <input type="text" id="search-input" placeholder="Enter IATA code, airport name, or city">
    <div id="search-results"></div>
  </div>

  <!-- Changelog Modal (Hidden by Default) -->
  <div class="modal">
    <div class="modal-content">
      <span class="modal-close" style="float:right;cursor:pointer;">&times;</span>
      <h2>Changelog</h2>
      <ul id="changelog-list">
	    <li>2023-07-28: Added weather forcasts and temperature data to all American cities. May have lost some airports adding GPS Data.</li>
		<li>2023-07-28: Told Kevin about this tool. He liked it.
        <li>2023-07-27: Added functionality to search by partial airport names (e.g., "Tyson" for "McGhee Tyson Airport").</li>
        <li>2023-07-27: Modified search to prioritize IATA codes over city names.</li>
        <li>2023-07-27: Added IATA code display in search results.</li>
        <li>2023-07-25: Added 400+ new airports in United States, Canada, and The Bahamas.</li>
        <li>2023-07-24: Initial version of the Airport Time Zone Search tool.</li>
      </ul>
    </div>
  </div>

  <!-- Changelog Link -->
  <div class="changelog-link">Changelog</div>

<script>
  const airports = [
    {"iataCode": "ABE", "name": "Lehigh Valley International Airport", "city": "Allentown", "state": "Pennsylvania", "timeZone": "America/New_York", "latitude": 40.65236, "longitude": -75.44040},
    // Add more airports to this array if needed
  ];

  let currentAirportCode = null;

  async function fetchWeatherForecast(foundAirport) {
    try {
      const pointsResponse = await fetch(`https://api.weather.gov/points/${foundAirport.latitude},${foundAirport.longitude}`);
      const pointsData = await pointsResponse.json();
      const forecastURL = pointsData.properties.forecast;

      if (!forecastURL) {
        throw new Error("Forecast URL not found.");
      }

      const forecastResponse = await fetch(forecastURL);
      const forecastData = await forecastResponse.json();

      const today = new Date();
      const periodsToday = forecastData.properties.periods.filter(period => {
        const periodStartTime = new Date(period.startTime);
        return periodStartTime.getDate() === today.getDate() &&
          periodStartTime.getMonth() === today.getMonth() &&
          periodStartTime.getFullYear() === today.getFullYear();
      });

      let forecastHTML = '<h3>Weather Forecast</h3>';
      for (const period of periodsToday) {
        forecastHTML += `<p><strong>${period.name}:</strong> ${period.shortForecast}, ${period.temperature}&deg; ${period.temperatureUnit}</p>`;
      }

      // Update the weather forecast section with the new data
      document.getElementById('weather-forecast').innerHTML = forecastHTML;

    } catch (error) {
      console.error("Error fetching weather forecast:", error);
    }
  }

  function updateAirportTime(foundAirport) {
    const currentTimeElement = document.getElementById(`current-time-${foundAirport.iataCode}`);
    setInterval(() => {
      const currentTime = moment.tz(foundAirport.timeZone).format("YYYY-MM-DD HH:mm:ss z");
      currentTimeElement.textContent = currentTime;
    }, 1000); // Set the interval to 1000ms (1 second)
  }

  async function searchAirport() {
    const searchInput = document.getElementById("search-input").value.trim().toUpperCase();
    const searchResultsDiv = document.getElementById("search-results");

    if (searchInput === "") {
      searchResultsDiv.innerHTML = "";
      currentAirportCode = null;
      return;
    }

    // First, try to find an exact match in iataCode or name
    let foundAirport = airports.find(airport => airport.iataCode === searchInput || airport.name.toUpperCase() === searchInput);

    if (!foundAirport) {
      // If no exact match, try to find a partial match in iataCode, name, or city
      foundAirport = airports.find(airport => 
        airport.iataCode.includes(searchInput) ||
        airport.name.toUpperCase().includes(searchInput) ||
        airport.city.toUpperCase().startsWith(searchInput)
      );

      // If still no match, check if the search input starts with "K"
      if (!foundAirport && searchInput.startsWith("K")) {
        // Try removing the leading "K" and search again
        const withoutKInput = searchInput.substring(1);
        foundAirport = airports.find(airport => 
          airport.iataCode.includes(withoutKInput) ||
          airport.name.toUpperCase().includes(withoutKInput) ||
          airport.city.toUpperCase().startsWith(withoutKInput)
        );
      }
    }

    if (foundAirport) {
      // Check if the found airport is different from the current airport
      if (currentAirportCode !== foundAirport.iataCode) {
        currentAirportCode = foundAirport.iataCode;

        const currentTime = moment.tz(foundAirport.timeZone).format("YYYY-MM-DD HH:mm:ss z");
        let locationInfo = `<p><strong>IATA Code:</strong> ${foundAirport.iataCode}</p>`;
        locationInfo += `<p><strong>Airport:</strong> ${foundAirport.name}</p>`;
        if (foundAirport.city) {
          locationInfo += `<p><strong>City:</strong> ${foundAirport.city}</p>`;
        }
        if (foundAirport.state) {
          locationInfo += `<p><strong>State:</strong> ${foundAirport.state}</p>`;
        }
        locationInfo += `<p><strong>Time Zone:</strong> <span id="current-time-${foundAirport.iataCode}">${currentTime}</span></p>`;

        // Display both the airport information and weather forecast
        searchResultsDiv.innerHTML = locationInfo + '<div id="weather-forecast"></div>';

        // Fetch and display the weather forecast after showing the airport information
        fetchWeatherForecast(foundAirport);

        // Set interval to update the current time every second
        updateAirportTime(foundAirport);
      }
    } else {
      searchResultsDiv.innerHTML = `<p>No airport found for "${searchInput}".</p>`;
      currentAirportCode = null;
    }
  }

  document.getElementById("search-input").addEventListener("input", searchAirport);

  // Initialization
  document.getElementById("search-input").value = "";
  document.getElementById("search-results").dataset.airportCode = "";
</script>

<script>
  // Function to display the changelog modal
  function showChangelogModal() {
    const changelogModal = document.querySelectorAll(".modal")[1]; // Select the second modal element
    changelogModal.style.display = "block";

    const modalClose = document.querySelectorAll(".modal-close")[1]; // Select the second modal close button
    modalClose.onclick = () => {
      changelogModal.style.display = "none";
    };

    window.onclick = (event) => {
      if (event.target === changelogModal) {
        changelogModal.style.display = "none";
      }
    };
  }

  // Show the changelog modal when the changelog link is clicked
  document.querySelector(".changelog-link").addEventListener("click", showChangelogModal);

  // Show the work in progress modal on page load
  window.onload = () => {
    const modal = document.querySelector(".modal"); // Select the first modal element
    modal.style.display = "block";

    const modalClose = document.querySelector(".modal-close"); // Select the first modal close button
    modalClose.onclick = () => {
      modal.style.display = "none";
    };

    window.onclick = (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    };
  };
</script>
</body>
</html>


